services:
  recognition:
    build: .
    image: insightface-recognition:latest
    container_name: insightface-recognition
    stdin_open: true
    tty: true
    working_dir: /workspace/arcface_torch
    command: "torchrun --nproc_per_node=3 train_v2.py configs/merged_ms1m_glint_r100"
    environment:
      - OMP_NUM_THREADS=1
      - WANDB_API_KEY=${WANDB_API_KEY}
      - WANDB_ENTITY=${WANDB_ENTITY}
      - WANDB_PROJECT=${WANDB_PROJECT}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      - .:/workspace
      - /data/datasets/recognition:/datasets
      - /home/svision/experiments/recognition/output:/output
    shm_size: '16g'
    networks:
      - svision_experiments
    restart: unless-stopped

  minio:
    container_name: devbox-dataholder-minio
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      - MINIO_ACCESS_KEY=${MINIO_USER}
      - MINIO_SECRET_KEY=${MINIO_PASS}
    ports:
      - "10006:9001"
      - "${MINIO_PUBLIC_PORT}:${MINIO_PORT}"
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-.}/volumes/minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${MINIO_PORT}/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - svision_experiments
    restart: unless-stopped

  minio-mc:
    image: minio/mc
    container_name: devbox-minio-mc
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      sleep 5 &&
      mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASS} &&
      mc mb --ignore-existing myminio/face-dataset-bucket &&
      mc anonymous set download myminio/face-dataset-bucket &&
      echo 'MinIO bucket setup completed successfully' &&
      exit 0
      "
    networks:
      - svision_experiments

networks:
  svision_experiments:
    name: svision_experiments_net
    driver: bridge